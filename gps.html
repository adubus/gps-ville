<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Ville</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { margin: 5px 0; width: 100%; padding: 8px; }
    button { margin-top: 10px; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
<h2>Itinéraire</h2>

<label for="from">Ville de départ (laisser vide = position actuelle) :</label>
<input type="text" id="from" placeholder="Ex: Paris" />

<label for="to">Ville d’arrivée (obligatoire) :</label>
<input type="text" id="to" placeholder="Ex: Arradon" />

<button onclick="getCoordinates()">Obtenir les coordonnées</button>

<div id="results" style="margin-top:20px;"></div>

<button id="geovelo-btn" style="display:none;">Ouvrir dans Geovelo</button>
<button id="copy-geovelo-btn" style="display:none;">Copier l'URL Geovelo</button>
<button id="googlemaps-btn" style="display:none;">Ouvrir dans Google Maps</button>
<button id="applemaps-btn" style="display:none;">Ouvrir dans Apple Plans</button>
<button id="waze-web-btn" style="display:none;">Ouvrir dans Waze Web</button>

<script>
  let fromLat, fromLon, toLat, toLon;

  async function getCoordinates() {
    const from = document.getElementById('from').value.trim();
    const to = document.getElementById('to').value.trim();
    const results = document.getElementById('results');
    results.textContent = 'Recherche en cours...';

    if (!to) {
      results.textContent = 'Veuillez renseigner une ville d’arrivée.';
      hideAllButtons();
      return;
    }

    try {
      // Récupérer coordonnées ville arrivée
      const toRes = await fetch(`https://corsproxy.io/?https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(to)}`);
      const toData = await toRes.json();

      if (!toData.length) {
        results.textContent = 'Ville d’arrivée non trouvée.';
        hideAllButtons();
        return;
      }

      toLat = toData[0].lat;
      toLon = toData[0].lon;

      if (from === '') {
        // Sans ville de départ : récupérer la position GPS
        navigator.geolocation.getCurrentPosition(pos => {
          fromLat = pos.coords.latitude;
          fromLon = pos.coords.longitude;
          showResultsAndButtons();
        }, err => {
          results.textContent = "Impossible d'obtenir la position GPS.";
          hideAllButtons();
        });
      } else {
        // Avec ville de départ : récupérer ses coordonnées
        const fromRes = await fetch(`https://corsproxy.io/?https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(from)}`);
        const fromData = await fromRes.json();

        if (!fromData.length) {
          results.textContent = 'Ville de départ non trouvée.';
          hideAllButtons();
          return;
        }

        fromLat = fromData[0].lat;
        fromLon = fromData[0].lon;
        showResultsAndButtons();
      }
    } catch (e) {
      results.textContent = 'Erreur lors de la récupération des données.';
      hideAllButtons();
    }
  }

  function showResultsAndButtons() {
    const results = document.getElementById('results');
    results.innerHTML = `
      <strong>Coordonnées :</strong><br>
      De : ${fromLat}, ${fromLon}<br>
      À : ${toLat}, ${toLon}
    `;

    const isIos = isIOS();

    document.getElementById('geovelo-btn').style.display = isIos ? 'none' : 'inline-block';
    document.getElementById('copy-geovelo-btn').style.display = isIos ? 'inline-block' : 'none';
    document.getElementById('googlemaps-btn').style.display = 'inline-block';
    document.getElementById('applemaps-btn').style.display = 'inline-block';
    document.getElementById('waze-web-btn').style.display = 'inline-block';
  }

  function hideAllButtons() {
    ['geovelo-btn', 'copy-geovelo-btn', 'googlemaps-btn', 'applemaps-btn', 'waze-web-btn'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
  }

  function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  document.getElementById('geovelo-btn').onclick = () => {
    window.location.href = `https://geovelo.app/fr/route/?from=${fromLon},${fromLat}&to=${toLon},${toLat}`;
  };

  document.getElementById('copy-geovelo-btn').onclick = () => {
    const url = `https://geovelo.app/fr/route/?from=${fromLon},${fromLat}&to=${toLon},${toLat}`;
    navigator.clipboard.writeText(url).then(() => {
      alert('URL Geovelo copiée dans le presse-papier !');
    }).catch(() => {
      alert('Erreur lors de la copie de l\'URL.');
    });
  };

  document.getElementById('googlemaps-btn').onclick = () => {
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${fromLat},${fromLon}&destination=${toLat},${toLon}`, '_blank');
  };

  document.getElementById('applemaps-btn').onclick = () => {
    window.open(`https://maps.apple.com/?saddr=${fromLat},${fromLon}&daddr=${toLat},${toLon}`, '_blank');
  };

  document.getElementById('waze-web-btn').onclick = () => {
    window.open(`https://www.waze.com/fr/live-map/directions?navigate=yes&from=ll.${fromLat},${fromLon}&to=ll.${toLat},${toLon}`, '_blank');
  };
</script>
<button onclick="window.location.href='index.html'" style="
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 10px 20px;
  margin: 1em;
  font-size: 1em;
  border-radius: 8px;
  cursor: pointer;
">
  ⬅️ Retour à l’accueil
</button>

</body>
</html>

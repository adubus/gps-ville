<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heures de Marée</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background-color: #f0f8ff;
    }
    h1 {
      text-align: center;
    }
    label, input, button {
      font-size: 1em;
      display: block;
      margin: 0.5em 0;
    }
    #result {
      margin-top: 1em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>Horaires des Marées</h1>

  <label for="ville">Ville côtière :</label>
  <input type="text" id="ville" placeholder="ex : Saint-Malo" />
  <button onclick="obtenirMarees()">Obtenir les marées</button>

  <div id="result"></div>

  <script>
    const API_KEY = "7499ed9f-fbe6-4297-9220-9fd879366b4a";

    async function obtenirMarees() {
      const ville = document.getElementById("ville").value.trim();
      const result = document.getElementById("result");
      result.innerHTML = "Chargement…";

      try {
        // Étape 1 : obtenir les coordonnées GPS
        const geocode = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(ville)}&format=json`)
          .then(res => res.json());
        if (!geocode.length) throw new Error("Ville introuvable");
        const { lat, lon } = geocode[0];

        // Étape 2 : date du jour à minuit
        const today = new Date();
        const dateStr = today.toISOString().split("T")[0];
        const midnightTimestamp = Math.floor(new Date(dateStr + "T00:00:00Z").getTime() / 1000);

        // Étape 3 : appel API marées
        const tide = await fetch(`https://corsproxy.io/?${encodeURIComponent(
          `https://www.worldtides.info/api/v3?extremes&heights&lat=${lat}&lon=${lon}&start=${midnightTimestamp}&length=86400&key=${API_KEY}`
        )}`).then(r => r.json());

        // Étape 4 : filtrer les marées du jour
        const events = tide.extremes.filter(e => {
          const d = new Date(e.date);
          return d.toLocaleDateString("fr-FR") === today.toLocaleDateString("fr-FR");
        }).map(e => {
          const d = new Date(e.date);
          const h = d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
          return {
            type: e.type,
            time: h,
            height: tide.heights.find(h2 =>
              Math.abs(new Date(h2.dt * 1000).getTime() - d.getTime()) < 5 * 60 * 1000
            )?.height || null
          };
        });

        if (!events.length) {
          result.innerHTML = "Aucune marée trouvée pour aujourd’hui.";
          return;
        }

        // Affichage
        result.innerHTML = `<h2>Marées du ${today.toLocaleDateString("fr-FR")} à ${ville}</h2><ul>` +
          events.map(e =>
            `<li><strong>${e.type === "High" ? "Marée haute" : "Marée basse"}</strong> à ${e.time}` +
            (e.height ? ` — ${e.height.toFixed(2)} m` : "") + `</li>`
          ).join("") +
          `</ul>`;
      } catch (err) {
        console.error(err);
        result.innerHTML = `<span style="color:red">Erreur : ${err.message}</span>`;
      }
    }
  </script>
</body>
</html>

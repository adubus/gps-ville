<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Horaires des Marées</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background-color: #f0f8ff;
    }
    h1 {
      text-align: center;
    }
    label, input, button {
      font-size: 1em;
      display: block;
      margin: 0.5em 0;
    }
    #result {
      margin-top: 1em;
      background: #fff;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>Horaires des Marées</h1>

  <label for="ville">Ville côtière :</label>
  <input type="text" id="ville" placeholder="ex : Saint-Malo" />
  <button onclick="obtenirMarees()">Obtenir les marées</button>

  <div id="result"></div>

  <script>
    const API_KEY = "7499ed9f-fbe6-4297-9220-9fd879366b4a";

    async function obtenirMarees() {
      const ville = document.getElementById("ville").value.trim();
      const result = document.getElementById("result");
      result.innerHTML = "Chargement…";

      try {
        // Étape 1 : obtenir les coordonnées GPS
        const geocode = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(ville)}&format=json`)
          .then(res => res.json());
        if (!geocode.length) throw new Error("Ville introuvable");
        const { lat, lon } = geocode[0];

        // Étape 2 : calculer minuit UTC du jour actuel
        const now = new Date();
        const utcMidnight = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        const utcTimestamp = Math.floor(utcMidnight.getTime() / 1000);

        // Étape 3 : appel API WorldTides
        const tide = await fetch(`https://corsproxy.io/?${encodeURIComponent(
          `https://www.worldtides.info/api/v3?extremes&lat=${lat}&lon=${lon}&start=${utcTimestamp}&length=86400&key=${API_KEY}`
        )}`).then(r => r.json());

        // Étape 4 : filtrer événements marées pour la date locale
        const events = tide.extremes.filter(e => {
          const d = new Date(e.date);
          return d.getDate() === now.getDate() &&
                 d.getMonth() === now.getMonth() &&
                 d.getFullYear() === now.getFullYear();
        });

        if (!events.length) {
          result.innerHTML = "Aucune marée trouvée pour aujourd’hui.";
          return;
        }

        // Affichage
        result.innerHTML = `<h2>Marées du ${now.toLocaleDateString("fr-FR")} à ${ville}</h2><ul>` +
          events.map(e => {
            const d = new Date(e.date);
            const heure = d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
            return `<li><strong>${e.type === "High" ? "Marée haute" : "Marée basse"}</strong> à ${heure}</li>`;
          }).join("") +
          `</ul>`;
      } catch (err) {
        console.error(err);
        result.innerHTML = `<span style="color:red">Erreur : ${err.message}</span>`;
      }
    }
  </script>
</body>
</html>
